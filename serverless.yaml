# serverless.yml

service: nwassik-store

frameworkVersion: "4"

plugins:
  # NOTE: By default, Serverless doesn't know how to bundle Python packages
  - serverless-python-requirements

package:
  patterns: # import the bare minimum (minimalistic)
    - "src/"
    - "README.md"
    - "requirements.txt"
    - "serverless.yaml"
    - "!.gitignore"
    - "!venv/**" # ← Explicitly exclude venv
    - "!node_modules/**" # ← Explicitly exclude node_modules
    - "!__pycache__/**" # ← Explicitly exclude pycache
custom:
  # IMPORTANT: Always deploy with --stage flag (dev, staging, or prod)
  # Default stage 'NotToUseStage' will fail to force explicit stage selection
  allowedStages:
    - dev
    - staging
    - prod

  stages:
    dev:
      baseDomain: https://api-dev.nwassik.com
      cognitoUserPoolId: ${env:COGNITO_USER_POOL_ID}
      cognitoAppClientId: ${env:COGNITO_APP_CLIENT_ID}
    staging:
      baseDomain: https://api-staging.nwassik.com
      cognitoUserPoolId: ${env:COGNITO_USER_POOL_ID}
      cognitoAppClientId: ${env:COGNITO_APP_CLIENT_ID}
    prod:
      baseDomain: https://api.nwassik.com
      cognitoUserPoolId: ${env:COGNITO_USER_POOL_ID}
      cognitoAppClientId: ${env:COGNITO_APP_CLIENT_ID}

  # NOTE: exact keyword needed by "serverless-python-requirements" plugin
  pythonRequirements:
    usePoetry: false
    dockerizePip: true # <<--- build wheels in Docker (required for compiled deps as I am on MacOS)
    useStaticCache: false # ← Disable cache

    dockerBuildCmd: |
      pip install \
        --platform manylinux2014_x86_64 \
        --target /var/task \
        --implementation cp \
        --python-version 3.11 \
        --only-binary=:all: \
        --upgrade \
        -r requirements.txt

provider:
  name: aws
  runtime: python3.11
  region: eu-west-3
  stage: NotToUseStage # NOTE: this is kept as a safeguard to force explicit stage selection as serverless framework defaults to dev...
  environment:
    RUN_ENV: cloud # Running in AWS Lambda (cloud) vs local
    STAGE: ${sls:stage} # used in Python code to detect Lambda stage
    BASE_DOMAIN: ${self:custom.stages.${sls:stage}.baseDomain, 'https://api-${sls:stage}.nwassik.com'} # Stage-specific API domain
    DATABASE_SECRET_NAME: "nwassik/${sls:stage}/app-db-secret" # Secrets Manager secret for application
    MAX_USER_CREATED_REQUESTS: 20
    MAX_USER_CREATED_FAVORITES: 100
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - secretsmanager:GetSecretValue
          Resource: arn:aws:secretsmanager:eu-west-3:689688455606:secret:nwassik/${sls:stage}/app-db-secret-*
        - Effect: Allow
          Action:
            - dsql:DbConnect
          Resource: arn:aws:dsql:eu-west-3:689688455606:cluster/*

  # NOTE: Using HTTP API (not REST API) because it's:
  #   ✅ 70% cheaper ($1/M vs $3.50/M requests)
  #   ✅ 60% faster (lower latency)
  #   ✅ Native and simple JWT authentication support
  #   ✅ Built-in CORS support
  #   ✅ Supports OpenAPI documentation
  #   ❌ Does NOT support request validation at gateway level
  #      (REST API can validate before Lambda runs; HTTP API cannot)
  #      Validation must be done in Lambda code
  #   ❌ Global throttling only (not per-user)
  #      Per-user rate limiting will be implemented in Lambda with Redis/DynamoDB later
  httpApi:
    # TODO: Add CORS configuration when connecting frontend
    authorizers:
      cognitoAuthorizer:
        type: jwt
        identitySource: $request.header.Authorization
        issuerUrl: https://cognito-idp.${aws:region}.amazonaws.com/${self:custom.stages.${sls:stage}.cognitoUserPoolId}
        audience:
          - ${self:custom.stages.${sls:stage}.cognitoAppClientId}

functions:
  # -----------------------------------------------------------------------------
  # HEALTH CHECK (Public - no authentication)
  # -----------------------------------------------------------------------------
  healthCheck:
    handler: src/handlers/health/check.health_check
    events:
      - httpApi:
          path: /health
          method: get

  # -----------------------------------------------------------------------------
  # REQUESTS
  # -----------------------------------------------------------------------------
  listRequests:
    handler: src/handlers/requests/list.list_requests
    events:
      - httpApi:
          path: /requests
          method: get

  createRequest:
    handler: src/handlers/requests/create.create_request
    events:
      - httpApi:
          path: /requests
          method: post
          authorizer:
            name: cognitoAuthorizer

  getRequest:
    handler: src/handlers/requests/get.get_request
    events:
      - httpApi:
          path: /requests/{request_id}
          method: get

  listUserRequests:
    handler: src/handlers/requests/list_user_requests.list_user_requests
    events:
      - httpApi:
          path: /users/{user_id}/requests
          method: get
          authorizer:
            name: cognitoAuthorizer

  deleteRequest:
    handler: src/handlers/requests/delete.delete_request
    events:
      - httpApi:
          path: /requests/{request_id}
          method: delete
          authorizer:
            name: cognitoAuthorizer

  updateRequest:
    handler: src/handlers/requests/update.update_request
    events:
      - httpApi:
          path: /requests/{request_id}
          method: patch
          authorizer:
            name: cognitoAuthorizer

  # -----------------------------------------------------------------------------
  # FAVORITES (All require authentication)
  # -----------------------------------------------------------------------------
  createFavorite:
    handler: src/handlers/favorites/create.create_favorite
    events:
      - httpApi:
          path: /favorites
          method: post
          authorizer:
            name: cognitoAuthorizer

  deleteFavorite:
    handler: src/handlers/favorites/delete.delete_favorite
    events:
      - httpApi:
          path: /favorites/{favorite_id}
          method: delete
          authorizer:
            name: cognitoAuthorizer

  listUserFavorites:
    handler: src/handlers/favorites/list.list_user_favorites
    events:
      - httpApi:
          path: /favorites
          method: get
          authorizer:
            name: cognitoAuthorizer
# -----------------------------------------------------------------------------
# RESOURCES
# -----------------------------------------------------------------------------
